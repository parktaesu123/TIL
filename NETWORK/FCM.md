## FCM

### 일반 알림과 푸시 알림?

> 일반 알림과 푸시 알림은 어떤차이가 있을까?
> 

### 일반 알림

> 사용자가 특정 작업을 하거나 시스템 상태가 변할 때, 해당 상태를 알려주는 **포괄적인 개념이다.**
> 
- 앱 내부 로직이나 기기에 저장된 데이터에 기반하여 표시된다.

### 푸시 알림

> 외부 서버(클라우드 또는 백엔드 시스템)에서 사용자의 기기로 실시간으로 푸시하는 알림
> 
- 서버가 푸시 서비스(예: Firebase Cloud Messaging, APNs)를 통해 기기로 알림을 보낸다.

<aside>

링크드인을 노트북으로 사용하면 링크드인에 접속하지 않았을 때는 연락이 오지 않아서 구글을 통해 링크드인에 접속했을 때 알림이 온것을 확인 할 수 있기 때문에 그냥 알림이라고 볼 수 있고, 링크드인을 모바일기기에서 다운로드하여 사용할때는 접속하지 않아도 누군가 나의 글에 하트를 누르거나 1촌 신청을 했을 때 알림이 오는 푸시알림으로 볼 수 있다.

</aside>

## **FCM(Firebase Cloud Messaging)이란?**

> 무료로 메시지를 안정적으로 전송할 수 있는 **교차 플랫폼 메시징 클라우드 서버**
> 
- 솔직히 뭔말인지 모르겠어서 차근차근 알아보자

### 교차 플랫폼

> 전자기기마다 운영체제(IOS)가 다르고 푸시알림을 보내는 방법도 운영체제 마다 다르다.
> 
- IOS는 APNS, Android는 GCM

<aside>

그렇지만 우리의 FCM은 교차 플랫폼을 지원하여 **애플리케이션에서 FCM을 이용해 알림 기능을 개발해두기만 하면 알아서 알림을 보내준다. → 디바이스의 종류와 관계없이 알림 메시징 서비스를 지원**

</aside>

### 클라우드 서버

> 기존 알림구현에 사용되는 이벤트 기반 폴링, Long Polling Web Socket SSE는 모두 서버의 자원을 지속해서 소모한다는 단점이 있다. 
이는 클라이언트가 알림 정보를 받기위해 서버와 직접 연결하기에 발생하는 문제점이라고 볼 수 있다.
> 

<aside>

🚀 **`FCM`**은 위와 같은 문제를 해결하기 위해 클라이언트와 서버 사이에 메시지 전송 전용 클라우드 서버를 하나 두고, 본체 서버가 아닌 클라우드 서버와 연결을 유지하면서 알림 정보를 주고 받도록 한다.

</aside>

- 애플리케이션 서버에서는 알림 발송이 필요한 그 순간에만 FCM 서버로 요청을 딱 보내고 응답도 즉시 받는 무상태(Stateless) 상호작용을 한다.
- 서버는 요청이 필요한 순간에만 데이터를 보내고, FCM 클라우드 서버와의 연결 상태를 유지하지 않는다.

## FCM의 동작 원리


(처음 로그인)

1. 클라이언트에서 FCM에 등록을 요청한다.
2. FCM은 Token을 클라이언트에게 발급한다.
3. 클라이언트는 앱서버에 자신의 정보와 해당 토큰을 전달하고 서버는 이를 맵핑하여 저장한다.
4. 맵핑된 정보를 토대로 앱서버는 푸시알림을 보내고 싶을때 클라이언트의 요청없이 FCM에 요청을 보낸다.
5. FCM은 앱서버에서 받은 토큰으로 해당 클라이언트를 찾아 푸시알림을 보낸다.

<aside>

**토큰은 스마트폰 자체에서 FCM으로 요청하는 것이 아닌 설치된 앱에서 요청을 하기 때문에 클라이언트가 가진 앱마다 FCM에서 받은 토큰은 모두 다르다**

</aside>

- 앱서버가 FCM토큰을 알고 있다면 위와 같은 구조가 가능해진다.
- 앱서버는 FCM과 무상태 연결을 하므로 독립적인 요청을 보낼 수 있다.

앱은 기본적으로  **`Foreground`, `Background` 상태**를 지닌다.

- **Foreground :** 앱을 실행시키고 앱의 UI가 노출되는 상태, 사용자가 조작 가능
- **Background :** 홈버튼을 눌러 앱을 종료하거나 다른 앱으로 전환했을 때, 앱을 키지않으면 사용자가 조작 불가능
    - 인스타그램을 예시로 알아보자
        
        > 인스타그램 앱을 키고 대화창이 활성화 되어 Foreground상태일 때는 FCM을 사용하지 않고 앱서버와 클라이언트간의 통신이 이루어진다.
        > 
        
        > 앱을 종료하고 누군가 나에게 DM을 보내면 앱서버가 FCM에 요청을 보내 Background상태의 디바이스에 인스타 데이터를 보낼 수 있다.
        > 

### 참고자료

https://velog.io/@idonymyeon/%EC%95%8C%EB%A6%BC-%EA%B5%AC%ED%98%84%ED%95%98%EA%B8%B0-2-%EC%99%84%EC%A0%84-%EC%89%BD%EA%B2%8C-%EC%95%8C%EC%95%84%EB%B3%B4%EB%8A%94-FCM

https://velog.io/@dionisos198/%EC%8A%A4%ED%94%84%EB%A7%81-%ED%91%B8%EC%8B%9C-%EC%95%8C%EB%A6%BC-%EA%B5%AC%ED%98%84%EC%98%88%EC%A0%9CFCM-%EC%82%AC%EC%9A%A9

https://donghun.dev/Firebase-Cloud-Messaging

https://wans1027.tistory.com/16
